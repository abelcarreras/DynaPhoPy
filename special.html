<!DOCTYPE html>
<html>

  <head>
    <script type="text/javascript"
            src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Dynaphopy : Phonon Analysis from Dynamical Data">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Dynaphopy</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <h2 id="project_tagline">Advanced options</h2>

        </header>
    </div>
    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
    	<section id="main_content" class="inner">

<a href="index.html"><div id="backbutton" s style="position:relative;right:-580px;top:-170px;width:60px"><body>Back</body></div></a>

<h3>Big data</h3>
<p>
In order to obtain well converged results in the calculation of anharmonic phonon properties, specially in phonon linewidths, 
usually it becomes necessary to use very long MD simulations. This requires long calculation times and imply to hadle very large 
files. Fortunatelly, in canonical ensemble the velocity time correlation decreases relativelly fast as the time advances. That means that
it becomes possible to join several independent MD trajectories to obtain a larger one with almost negligible added error. That allows to
calculate many independent MD simulations at the same time and join them later to obtain a larger MD trajectory and increase the accuracy of
the results.
<br>To support this task Dynaphopy can save the MD information into a hdf5 file to be read afterwards. Additionally I provide an independent
script called <strong>concath5</strong> which allows join several hdf5 files into one.
<br><em>Note: VASP code has to be compiled with advanced features in order to start MD from random velocities and generate different 
trajectories each run. Please, refere to VASP <a href=http://cms.mpi.univie.ac.at/vasp/vasp/Advanced_MD_techniques.html">documentation</a> 
for further information.</em></p>
<UL>
<LI><h5>Save data into hdf5 file </h5>
<p>Saving data into hdf5 file can be usefull in order to save space in the hard drive. Since only the necessary information for dynaphopy
is stored, this hdf5 file size can be around 5 times smaller than the original OUTCAR. Besides it allows to manipulate this information as
an intermediate step using concath5 or other third party software. To request to save MD trajectory into hdf5 file use 
<strong>-sv</strong> flag follower by the file name. 
<br>This option can be used alone  or together with other flags but, in any case, all time steps in OUTCAR file will be stored in the hdf5 file (<strong>-n</strong> 
flag has no effect in the number of time steps stored).</p>

<pre><code>$ ./dynaphopy input_file OUTCAR -sv filename.h5
</code></pre>

<LI><h5>Load data into hdf5 file </h5>
<p> Once saved into a hdf5 file, MD data can be load to dynaphopy using <strong>-lv</strong> flag. Loading data from hdf5 is much faster
than using OUTCAR file, if several calculation using the same data have to be done, it is highly recomended to use this option.
<br><em>Notice that when loading data this way, OUTCAR file has to not be set.</em></p>

<pre><code>$ ./dynaphopy input_file -lv filename.h5
</code></pre>

<LI><h5>Manipulating data</h5>
<p>
The structure of the hdf5 file is quite simple. With a minimum knowledge of programming it can be easly manipulated by third parties software.
In dynaphopy script directory a simple script for joining data is provided named <strong>concath5</strong>. It can be used as example 
for more complex ones. To use this script just call it followed by the name of all the hdf5 files to be joined and the last one 
the name of the new hdf5 file that will contain all the joined data. 
</p>
<pre><code>$ ./concath5 source1.h5 source2.h5 source3.h5 ··· joined.h5
</code></pre>
<p>
By default <strong>concath5</strong> skips the first 20000 time steps of each source MD trajectory. This is done to ensure that the MD
is totally converged in each file. Using <strong>-f</strong> flag, is possible to define the number of time steps to be skipped.
</p>

<pre><code>$ ./concath5 -f 30000 source1.h5 source2.h5 ··· joined.h5
</code></pre>

<p>
Depending on the processed MD simulation the size of the resulting hdf5 file could be huge. In the lastest version, by default 
concath5 stores all the velocity  as well as the trajectory coordinates at each timestep. To calculate the phonon related
properties using DynPhoPy only the velocity is needed. So if no atomic displacement calculation is needed option <nobr><strong>--velocity_only</strong></nobr>
can be used. This option makes concath5 script to not store the trajectory in the final hdf5 file saving HD space.
</p>
<pre><code>$ ./concath5 --velocity_only source1.h5 source2.h5 ··· joined.h5
</code></pre>

</UL>

<h3>MEM coeficient analysis</h3>
<p>
The correct setting of the number of coefficents in MEM algorithm to calculate the power spectrum is one of the crucial point to take in account.
Depending on the number of coefficents the peak width of the peaks may significantly change, which directly affects the phonon linewidths results.
<br>From my experience, if the MD simulations are long enough, as the number of coefficents increase the peak width become to stabilize while keeping the peaks shape smooth. Is to be expected than this stabilized width is more reliable even if the peaks become a little more uglyer.
<br>In order to check the evolution of the power spectra peaks width with the number of coefficents dynaphopy provides option <strong>-csa</strong>
which performs a scan for all peaks anf fits each one to Lorentzian function to extract width information.
All this information is plotted in 3 matplotlib windows for each phonon. 
</p>
<pre><code>$ ./dynaphopy input_file OUTCAR -csa
</code></pre>

<img src="images/coef_ana_2.png" alt="Interactive" style="width:605px">
<img src="images/coef_ana_1.png" alt="Interactive" style="width:605px">
<img src="images/coef_ana_3.png" alt="Interactive" style="width:605px">

<p>Additionally, it shows the optimum number of coeficients that has the best
fit with a Lorentzian function and estimates the peak width value taking a average for all coefficents ponderated by the inverse of fit error.</p>

<pre><code>Peak # 5
------------------------------------
Estimated width(FWHM): 0.0570242354113 THz
Position: 3.8546680966 THz
Optimum coefficients num: 336.0
Fitting Error: 2.31991499922e-07
</pre></code>

<h3>External power spectra analysis</h3>
<p>
The calculation of the power spectra, specially using Fourier transform method, can take a lot of time (maybe few days). For this reason the
calculation of these spectra may be done in a cluster computer in which may not have acces through graphical interface. This makes the fitting
analysis difficult since there is no way to evaluate visually if the fitting has been correctly done. Besides, the power spectrum obtained may
be noisy and a post processing may be needed to improve the fitting quality.
<br>In dynaphopy package, <strong>fitdata</strong> script is included in scripts folder to extract the anharmonic information from a power 
spectrum file obtained with Dynaphopy throught <strong>-sw</strong> or <strong>-sp</strong> options. This allows to first calculate the 
power spectrum using Dynaphopy in a cluster computer, saving it in a file and later extract the information in a local machine.
Additionally this script allows to smooth the spectrum using <a href="http://en.wikipedia.org/wiki/Local_regression">LOWESS</a> method before fitting it with a Lorentzian function.
<br>During the execution it shows the smoothing result and the fitting result for each spectrum present in the spectrum file allowing to test
different smoothing parameters to obtain the best results.
</p>
<UL>
<LI><h5>Simple execution</h5>
<p> By default the script takes all the spectra present in the file and fits them to a Lorentzian function (equivalent to Dynaphopy peak analysis).
</p>
<pre><code>$ fitdata file
</code></pre>
<img src="images/fitting.png" alt="Interactive" style="width:605px">

<LI><h5>Smoothing spectra using LOWESS method</h5>
<p>LOWESS method works very well removing the noise in very noisy spectra. This allows to obtain much better results in the fitting and, in many cases, it becomes indispensable in order to get a meaningful result. To do this, the visual analysis becomes crucial to compare the original noisy spectrum and the smoothed one to make sure that the essetial peak shape is kept. To request the smooth methos use <strong>-sm</strong> flag.
</p>
<pre><code>$ fitdata -sm file
</code></pre>

<img src="images/smooth.png" alt="Interactive" style="width:605px">
<img src="images/fit_smooth.png" alt="Interactive" style="width:605px">
<LI><h5>Changing smoothing parameters</h5>
<p> In case that the smoothing process is not succesfull, the LOWESS method can be ajusted via smoothing span parameter <strong>-f</strong> (Default: 0.2). Increasing its value will make the strectra smoother but will differ more from the original spectrum. 
</p>
<pre><code>$ fitdata -sm -f 0.4 file
</code></pre>

<LI><h5>Combining spectra</h5>
<p> In high symmetry points in the reciprocal space (wave vector), it may happen that two or more phonon are degenerated. In that case the projection into this wave vector and, consecutively, the power spectra should present the same properties (Width and position). In order to
increase the fitting precision these equivalent spectra can be conbined into one reducing the random error. This can be done using <strong>-bi</strong> flag. Following this flag it is nedeed to introduce a string containing the number of the spectra to be combined (equivalent spectra) separated by spaces and the non equivalent spectra separated by comma like in the following example:
</p>
<pre><code>$ fitdata -bi "1 2, 3 4 5"
</code></pre>

<p> in this example, the script will fit two phonon power spectra. The first one using the avarage of the spectra 1 and 2. The second one
using the average of spectra 3, 4 and 5.
</p>

</UL>

<h3>Atomic displacements calculation</h3>
<p>
DynaPhoPy allows to calculate the atomic displacements from the MD trajectory respect to a desired direction. 
The calculation of the atomic displacements requires (obviously) the previous load of the trajectory coordinates
information. In previous versions of DynaPhoPy, this trajectory was not stored in the hdf5 files, so if you load
the MD information from a hdf5 file, please make sure that contains also the trajectory coordinates. If not, you 
can use the lastest version of DynaPhoPy to extract the information from the OUTCAR file. The same can be applied 
for the use of <strong>concath5</strong> script.
<br>DynaPhoPy will still be compatible with hdf5 files which does not contain the trajectory and <strong>concath5</strong>
is able to create hdf5 files which contains only the velocity information using <strong>--velocity_only</strong> flag in 
order to reduce HD space.
<br>To request a atomic displacements calculation flags <strong>-pad</strong> and <strong>-sad</strong> are used,
<strong>pad</strong> will calculate the displacements and show the data in a matplolib plot:
</p>
<pre><code>$ dynaphopy input_file OUTCAR -pad  0 0 1
</code></pre>
<img src="images/atomic_displacements.png" alt="Interactive" style="width:605px">
<p>
this flag requires a set of three float numbers that compose the vector that indicates the direction into which
the atomic displacements will be analyzed.
<br>On the other hand, <strong>-sad</strong> flag does the same calculation as  <strong>-pad</strong> but instead of
showing the plot on the screen stores the information in a defined file:
</p>
<pre><code>$ dynaphopy input_file OUTCAR -sad  0 0 1 displacements_file.out
</code></pre>
<p>
The file contains a column for each nonequivalent atom in the unit cell. The first column correspond to the displacement
coordinate.
</p>







    </section>
    </div>
    
    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Dynaphopy maintained by <a href="https://github.com/abelcarreras">abelcarreras</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>
    
  </body>
</html>